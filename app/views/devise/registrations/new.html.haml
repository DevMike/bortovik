%h2 Sign up
= simple_form_for(resource, :as => resource_name, :url => registration_path(resource_name)) do |f|
  = f.error_notification
  .inputs
    = f.input :name, :required => true, :autofocus => true
    = f.input :email, :required => true
    = f.input :password, :required => true
    = f.input :password_confirmation, :required => true
    = f.input :country, :collection => country_collection
    = f.input :region, :collection => region_collection
    = f.input :settlement, :required => true, :collection => settlement_collection
    = f.input :agree, :required => true, :label => 'I agree with terms', :input_html => {:type => 'checkbox'}
  .actions
    = f.button :submit, "Sign up"
= render :partial => "devise/shared/links"

- content_for :js do
  :javascript
    $(document).ready(function(){
        validate_forms();
        restrict_location();
    });

    function validate_forms(){
        $('form').submit(function(){
            var allow_submit = true;
            form = $(this);
            $('input[type=checkbox]', form).each(function(){
                el = $(this);
                if (el.attr('name').match(/\[agree\]/)){
                    if (el.attr('checked') == 'checked'){
                        el.parent().removeClass('failed');
                    }
                    else{
                        el.parent().addClass('failed');
                        allow_submit = false;
                    }
                }
            });
            return allow_submit;
        });
    }

    function restrict_location(){
        $('#new_user select').live('change', function(){
            var select = $(this);
                value = select.val(),
                name = select.attr('name').match(/[^\[]+(?=\])/),
                ids = {
                  country: 'user_region',
                  region: 'user_settlement'
                },
                currentCountry = $("#user_country").val();
                currentRegion = $("#user_region").val();
                path = '/locations/';
                urls = {
                  country: path + currentCountry,
                  region: path + currentCountry + '/' + currentRegion
                },
                url = urls[name];
            if (url == undefined) return;
            if (value == "") return;

            $.ajax({
                url: url,
                success: function(data){
                    var el = $("#" + ids[name]);
                    el.html('');
                    for (n in data){
                        var option = $('<option></option>');
                        option.attr('value', n);
                        option.text(data[n]);
                        option.clone().appendTo(el);
                    }
                }
            })
        });
    }